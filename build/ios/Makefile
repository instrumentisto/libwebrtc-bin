include ../../VERSION

BASE_DIR := $(CURDIR)/../..

include ../env.mk

TARGET_OS ?= ios
TARGET_CPU =

include ../common.mk

.PHONY: all
all: clean build package

.PHONY: package
package:
	mkdir -p $(PACKAGE_DIR) && \
	cd $(BUILD_DIR_DEBUG) && \
	zip -9 -r $(PACKAGE_DIR)/$(subst $(space),,$(PACKAGE_NAME))_debug.zip WebRTC.xcframework/* && \
	cd $(BUILD_DIR_RELEASE) && \
	zip -9 -r $(PACKAGE_DIR)/$(subst $(space),,$(PACKAGE_NAME))_release.zip WebRTC.xcframework/*

.PHONY: patch
patch: common-patch
	echo "apply iOS patches ..." \
	&& cd $(SRC_DIR) \
	&& patch -p1 < $(PATCH_DIR)/disable_gdwarf-aranges.patch \
	&& patch -p1 < $(PATCH_DIR)/ios_disable_iossim.patch

.PHONY: build
build: patch
	cd $(SRC_DIR)/tools_webrtc/ios && \
	python3 build_ios_libs.py -o $(BUILD_DIR_DEBUG) --build_config release --bitcode --extra-gn-args '\
	  use_xcode_clang=true \
	  use_rtti=true \
	  enable_dsyms=true \
	  rtc_libvpx_build_vp9=true \
	  rtc_include_tests=false \
	  rtc_build_tools=false \
	  rtc_build_examples=false \
	  rtc_use_h264=false \
	  libcxx_abi_unstable=false \
	  $(CC_WRAPPER) \
	' && \
	python3 build_ios_libs.py -o $(BUILD_DIR_RELEASE) --build_config debug --bitcode --extra-gn-args '\
	  use_xcode_clang=true \
	  use_rtti=true \
	  enable_dsyms=true \
	  rtc_libvpx_build_vp9=true \
	  rtc_include_tests=false \
	  rtc_build_tools=false \
	  rtc_build_examples=false \
	  rtc_use_h264=false \
	  libcxx_abi_unstable=false \
	  $(CC_WRAPPER) \
	'

